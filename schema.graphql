# Schema for StrDomainsNFT Subgraph

type Account @entity {
  id: ID! # address
  tokens: [Token!]! @derivedFrom(field: "owner")
  createdTokens: [Token!]! @derivedFrom(field: "creator")
  salesAsBuyer: [Sale!]! @derivedFrom(field: "buyer")
  listings: [Listing!]! @derivedFrom(field: "seller")
  purchases: [Purchase!]! @derivedFrom(field: "buyer")
}

type Token @entity {
  id: ID! # tokenId
  tokenId: BigInt!
  owner: Account!
  creator: Account!
  tokenURI: String!
  domainName: String!
  mintedAt: BigInt!
  
  # Royalty information
  royaltySplitter: RoyaltySplitter
  royaltyBps: BigInt
  
  # Sale information
  lastSalePrice: BigInt
  lastSaleAt: BigInt
  sales: [Sale!]! @derivedFrom(field: "token")
  
  # Marketplace listings
  listings: [Listing!]! @derivedFrom(field: "token")
  
  # Transfer history
  transfers: [Transfer!]! @derivedFrom(field: "token")
  
  # Metadata
  blockNumber: BigInt!
  transactionHash: Bytes!
}

type RoyaltySplitter @entity {
  id: ID! # splitter address
  address: Bytes!
  creator: Account!
  treasury: Account!
  creatorBps: BigInt!
  treasuryBps: BigInt!
  
  # Associated token
  token: Token
  
  # Royalty events
  received: [RoyaltyReceived!]! @derivedFrom(field: "splitter")
  tokenReceived: [RoyaltyTokenReceived!]! @derivedFrom(field: "splitter")
  withdrawals: [RoyaltyWithdraw!]! @derivedFrom(field: "splitter")
  tokenWithdrawals: [RoyaltyTokenWithdraw!]! @derivedFrom(field: "splitter")
  
  # Balances
  ethBalance: BigInt!
  creatorEthBalance: BigInt!
  treasuryEthBalance: BigInt!
  erc20Balances: [RoyaltyBalance!]! @derivedFrom(field: "splitter")
  
  createdAt: BigInt!
  blockNumber: BigInt!
  transactionHash: Bytes!
}

type RoyaltyBalance @entity {
  id: ID! # splitter-token address
  splitter: RoyaltySplitter!
  token: Bytes! # ERC20 token address
  creatorBalance: BigInt!
  treasuryBalance: BigInt!
}

type Sale @entity {
  id: ID! # transactionHash-logIndex
  token: Token!
  buyer: Account!
  price: BigInt!
  timestamp: BigInt!
  blockNumber: BigInt!
  transactionHash: Bytes!
}

type Transfer @entity {
  id: ID! # transactionHash-logIndex
  token: Token!
  from: Account!
  to: Account!
  timestamp: BigInt!
  blockNumber: BigInt!
  transactionHash: Bytes!
}

type RoyaltyReceived @entity {
  id: ID! # transactionHash-logIndex
  splitter: RoyaltySplitter!
  from: Bytes!
  amount: BigInt!
  timestamp: BigInt!
  blockNumber: BigInt!
  transactionHash: Bytes!
}

type RoyaltyTokenReceived @entity {
  id: ID! # transactionHash-logIndex
  splitter: RoyaltySplitter!
  token: Bytes! # ERC20 token address
  from: Bytes!
  amount: BigInt!
  timestamp: BigInt!
  blockNumber: BigInt!
  transactionHash: Bytes!
}

type RoyaltyWithdraw @entity {
  id: ID! # transactionHash-logIndex
  splitter: RoyaltySplitter!
  to: Bytes!
  amount: BigInt!
  timestamp: BigInt!
  blockNumber: BigInt!
  transactionHash: Bytes!
}

type RoyaltyTokenWithdraw @entity {
  id: ID! # transactionHash-logIndex
  splitter: RoyaltySplitter!
  token: Bytes! # ERC20 token address
  to: Bytes!
  amount: BigInt!
  timestamp: BigInt!
  blockNumber: BigInt!
  transactionHash: Bytes!
}

# Global contract state
type Contract @entity {
  id: ID! # contract address
  treasury: Bytes!
  splitterFactory: Bytes!
  defaultRoyaltyBps: BigInt!
  lastId: BigInt!
}

# Marketplace contract state
type Marketplace @entity {
  id: ID! # marketplace address
  feeTreasury: Bytes!
  marketplaceFeeBps: BigInt!
  accruedFees: BigInt!
  lastListingId: BigInt!
  
  # Events
  listings: [Listing!]! @derivedFrom(field: "marketplace")
  purchases: [Purchase!]! @derivedFrom(field: "marketplace")
  feeWithdrawals: [FeeWithdrawal!]! @derivedFrom(field: "marketplace")
  
  createdAt: BigInt!
  blockNumber: BigInt!
  transactionHash: Bytes!
}

type Listing @entity {
  id: ID! # listingId
  listingId: BigInt!
  marketplace: Marketplace!
  seller: Account!
  nft: Bytes! # NFT contract address
  token: Token!
  tokenId: BigInt!
  price: BigInt!
  active: Boolean!
  
  # Events
  purchase: Purchase
  
  createdAt: BigInt!
  updatedAt: BigInt
  canceledAt: BigInt
  blockNumber: BigInt!
  transactionHash: Bytes!
}

type Purchase @entity {
  id: ID! # transactionHash-logIndex
  marketplace: Marketplace!
  listing: Listing!
  listingId: BigInt!
  buyer: Account!
  token: Token!
  price: BigInt!
  royaltyReceiver: Bytes!
  royaltyAmount: BigInt!
  feeAmount: BigInt!
  sellerAmount: BigInt!
  timestamp: BigInt!
  blockNumber: BigInt!
  transactionHash: Bytes!
}

type FeeWithdrawal @entity {
  id: ID! # transactionHash-logIndex
  marketplace: Marketplace!
  to: Bytes!
  amount: BigInt!
  timestamp: BigInt!
  blockNumber: BigInt!
  transactionHash: Bytes!
}
